"use strict";var Q3D={VERSION:"2.0.1",Options:{bgcolor:null,light:{directional:{azimuth:220,altitude:45}},side:{color:13085842,bottomZ:-1.5},frame:{color:0,bottomZ:-1.5},label:{visible:!0,connectorColor:12632272,autoSize:!1,minFontSize:10},qmarker:{r:.25,c:16776960,o:.8},debugMode:!1,exportMode:!1,jsonLoader:"JSONLoader"},LayerType:{DEM:"dem",Point:"point",Line:"line",Polygon:"polygon"},MaterialType:{MeshLambert:0,MeshPhong:1,LineBasic:2,Sprite:3,Unknown:-1}};Q3D.uv={i:new THREE.Vector3(1,0,0),j:new THREE.Vector3(0,1,0),k:new THREE.Vector3(0,0,1)},Q3D.ua=window.navigator.userAgent.toLowerCase(),Q3D.isIE=-1!=Q3D.ua.indexOf("msie")||-1!=Q3D.ua.indexOf("trident"),Q3D.isTouchDevice="ontouchstart"in window,Q3D.$=function(e){return document.getElementById(e)},Q3D.Group=function(){THREE.Group.call(this)},Q3D.Group.prototype=Object.create(THREE.Group.prototype),Q3D.Group.prototype.constructor=Q3D.Group,Q3D.Group.prototype.add=function(e){THREE.Group.prototype.add.call(this,e),e.updateMatrixWorld()},Q3D.Group.prototype.clear=function(){for(var e=this.children.length-1;0<=e;e--)this.remove(this.children[e])},Q3D.Scene=function(){THREE.Scene.call(this),this.autoUpdate=!1,this.rotation.x=-Math.PI/2,this.updateMatrixWorld(),this.mapLayers={},this.lightGroup=new Q3D.Group,this.add(this.lightGroup),this.labelConnectorGroup=new Q3D.Group,this.add(this.labelConnectorGroup),this.labelRootElement=null},Q3D.Scene.prototype=Object.create(THREE.Scene.prototype),Q3D.Scene.prototype.constructor=Q3D.Scene,Q3D.Scene.prototype.add=function(e){THREE.Scene.prototype.add.call(this,e),e.updateMatrixWorld()},Q3D.Scene.prototype.loadJSONObject=function(e){if("scene"==e.type){if(void 0!==e.properties){this.userData=e.properties;var t=this.userData.baseExtent[2]-this.userData.baseExtent[0],r=this.userData.baseExtent[3]-this.userData.baseExtent[1];this.userData.scale=this.userData.width/t,this.userData.zScale=this.userData.scale*this.userData.zExaggeration,this.userData.origin={x:this.userData.baseExtent[0]+t/2,y:this.userData.baseExtent[1]+r/2,z:-this.userData.zShift}}void 0!==e.lights&&this.lightGroup.clear(),0==this.lightGroup.children.length&&this.buildDefaultLights(),void 0!==e.layers&&e.layers.forEach(function(e){this.loadJSONObject(e)},this)}else if("layer"==e.type){if(void 0===(o=this.mapLayers[e.id])){var a=e.properties.type;if("dem"==a)o=new Q3D.DEMLayer;else if("point"==a)o=new Q3D.PointLayer;else if("line"==a)o=new Q3D.LineLayer;else{if("polygon"!=a)return;o=new Q3D.PolygonLayer}o.id=e.id,o.addEventListener("renderRequest",this.requestRender.bind(this)),this.mapLayers[e.id]=o,this.add(o.objectGroup)}o.loadJSONObject(e,this),this.requestRender()}else if("block"==e.type){var o;if(void 0===(o=this.mapLayers[e.layer]))return;o.loadJSONObject(e,this),this.requestRender()}},Q3D.Scene.prototype.buildDefaultLights=function(){this.lightGroup.add(new THREE.AmbientLight(10066329));var e=Q3D.Options.light.directional,t=Math.PI/180,r=(90-e.azimuth)*t,a=e.altitude*t,o=Math.cos(a)*Math.cos(r),i=Math.cos(a)*Math.sin(r),n=Math.sin(a),s=new THREE.DirectionalLight(16777215,.5);s.position.set(o,i,n),this.lightGroup.add(s);var l=new THREE.DirectionalLight(16777215,.1);l.position.set(-o,-i,-n),this.lightGroup.add(l)},Q3D.Scene.prototype.requestRender=function(){this.dispatchEvent({type:"renderRequest"})},Q3D.Scene.prototype.queryableObjects=function(){var e=[];for(var t in this.mapLayers)e=e.concat(this.mapLayers[t].queryableObjects());return e},Q3D.Scene.prototype.toMapCoordinates=function(e,t,r){if(this.userData.rotation){var a=this._rotatePoint({x:e,y:t},this.userData.rotation);e=a.x,t=a.y}return{x:e/this.userData.scale+this.userData.origin.x,y:t/this.userData.scale+this.userData.origin.y,z:r/this.userData.zScale+this.userData.origin.z}},Q3D.Scene.prototype._rotatePoint=function(e,t,r){var a=t*Math.PI/180,o=Math.cos(a),i=Math.sin(a),n=e.x,s=e.y;r&&(n-=r.x,s-=r.y);var l=n*o-s*i,c=n*i+s*o;return r&&(l+=r.x,c+=r.y),{x:l,y:c}},function(){var Q={};Q3D.application=Q;var a={},i=function(e){for(var t=a[e.type]||[],r=0;r<t.length;r++)t[r](e)};Q.addEventListener=function(e,t){a[e]=a[e]||[],a[e].push(t)},Q.init=function(e,t){if(Q.container=e,Q.running=!1,Q.urlParams=Q.parseUrlParameters(),"popup"in Q.urlParams){var r=window.location.href.split("?");return window.open(r[0]+"?"+r[1].replace(/&?popup/,""),"popup","width="+Q.urlParams.width+",height="+Q.urlParams.height),void Q.popup.show("Another window has been opened.")}Q.urlParams.width&&Q.urlParams.height&&(e.style.width=Q.urlParams.width+"px",e.style.height=Q.urlParams.height+"px"),e.clientWidth&&e.clientHeight?(Q.width=e.clientWidth,Q.height=e.clientHeight,Q._fullWindow=!1):(Q.width=window.innerWidth,Q.height=window.innerHeight,Q._fullWindow=!0);var a=Q3D.Options.bgcolor;Q.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),Q.renderer.setSize(Q.width,Q.height),Q.renderer.setClearColor(a||0,null===a?0:1),Q.container.appendChild(Q.renderer.domElement),Q.buildCamera(t),Q.scene=new Q3D.Scene,Q.scene.addEventListener("renderRequest",function(e){Q.render()});var o=Q.urlParams;void 0!==o.cx&&Q.camera.position.set(parseFloat(o.cx),parseFloat(o.cy),parseFloat(o.cz)),void 0!==o.ux&&Q.camera.up.set(parseFloat(o.ux),parseFloat(o.uy),parseFloat(o.uz)),void 0!==o.tx&&Q.camera.lookAt(parseFloat(o.tx),parseFloat(o.ty),parseFloat(o.tz));var i=new THREE.OrbitControls(Q.camera,Q.renderer.domElement);i.enableKeys=!1;var n=new THREE.Vector3,s=new THREE.Spherical;i.moveForward=function(e){n.copy(i.object.position).sub(i.target);var t=n.length()*Math.tan(i.object.fov/2*Math.PI/180);n.y=0,n.normalize(),n.multiplyScalar(-2*e*t/Q.renderer.domElement.clientHeight),i.object.position.add(n),i.target.add(n)},i.cameraRotate=function(e,t){n.copy(i.target).sub(i.object.position),s.setFromVector3(n),s.theta+=e,s.phi-=t,s.theta=Math.max(i.minAzimuthAngle,Math.min(i.maxAzimuthAngle,s.theta)),s.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,s.phi)),s.makeSafe(),n.setFromSpherical(s),i.target.copy(i.object.position).add(n),i.object.lookAt(i.target)},(Q.controls=i).update(),Q.labelVisibility=Q3D.Options.label.visible,Q.scene.labelRootElement=document.getElementById("labels"),Q.scene.labelRootElement.style.display=Q.labelVisibility?"block":"none";var l=Q3D.Options.qmarker;Q.queryMarker=new THREE.Mesh(new THREE.SphereBufferGeometry(l.r),new THREE.MeshLambertMaterial({color:l.c,opacity:l.o,transparent:l.o<1})),Q.queryMarker.visible=!1,Q.scene.add(Q.queryMarker),Q.highlightMaterial=new THREE.MeshLambertMaterial({emissive:10066176,transparent:!0,opacity:.5}),Q3D.isIE||(Q.highlightMaterial.side=THREE.DoubleSide),Q.selectedObject=null,Q.highlightObject=null,Q.modelBuilders=[],Q._wireframeMode=!1,window.addEventListener("keydown",Q.eventListener.keydown),window.addEventListener("resize",Q.eventListener.resize),Q.renderer.domElement.addEventListener("mousedown",Q.eventListener.mousedown),Q.renderer.domElement.addEventListener("mouseup",Q.eventListener.mouseup),i.addEventListener("change",function(e){Q.render()});var c=Q3D.$("closebtn");c&&c.addEventListener("click",Q.closePopup)},Q.parseUrlParameters=function(){var t,r={};return window.location.search.substring(1).split("&").concat(window.location.hash.substring(1).split("&")).forEach(function(e){t=e.split("="),r[t[0]]=t[1]}),r},Q.loadJSONObject=function(e){Q.scene.loadJSONObject(e)};var n=0;Q.loadFile=function(e,t,r){var a=function(e){"file:"==location.protocol&&Q.popup.show("This browser doesn't allow loading local files via Ajax. See <a href='https://github.com/minorua/Qgis2threejs/wiki/BrowserSupport'>plugin wiki</a> for details.","Error",!0)};n++;try{var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType=t,o.onload=function(){n--,r&&r(this.response),0==n&&i({type:"sceneLoaded"})},o.onerror=a,o.send(null)}catch(e){a()}},Q.loadJSONFile=function(e,t){Q.loadFile(e,"json",function(e){Q.loadJSONObject(e),t&&t(e)})},Q.loadTextureFile=function(e,t){return n++,(new THREE.TextureLoader).load(e,function(){n--,t&&t(),0==n&&i({type:"sceneLoaded"})})},Q.mouseDownPoint=new THREE.Vector2,Q.mouseUpPoint=new THREE.Vector2,Q.eventListener={keydown:function(e){var t=Q.controls,r=(e.which,2*Math.PI/180);if(e.shiftKey&&e.ctrlKey)switch(e.keyCode){case 38:t.dollyOut(t.getZoomScale());break;case 40:t.dollyIn(t.getZoomScale());break;default:return}else if(e.shiftKey)switch(e.keyCode){case 37:t.rotateLeft(r);break;case 38:t.rotateUp(r);break;case 39:t.rotateLeft(-r);break;case 40:t.rotateUp(-r);break;case 82:t.reset();break;case 83:return void Q.showPrintDialog();default:return}else if(e.ctrlKey)switch(e.keyCode){case 37:t.cameraRotate(r,0);break;case 38:t.cameraRotate(0,r);break;case 39:t.cameraRotate(-r,0);break;case 40:t.cameraRotate(0,-r);break;default:return}else switch(e.keyCode){case 37:t.panLeft(3,t.object.matrix);break;case 38:t.moveForward(9);break;case 39:t.panLeft(-3,t.object.matrix);break;case 40:t.moveForward(-9);break;case 27:return void Q.closePopup();case 73:return void Q.showInfo();case 76:return void Q.setLabelVisibility(!Q.labelVisibility);case 82:return void Q.setRotateAnimationMode(!t.autoRotate);case 87:return void Q.setWireframeMode(!Q._wireframeMode);default:return}Q.controls.update()},mousedown:function(e){Q.mouseDownPoint.set(e.clientX,e.clientY)},mouseup:function(e){Q.mouseUpPoint.set(e.clientX,e.clientY),Q.mouseDownPoint.equals(Q.mouseUpPoint)&&Q.canvasClicked(e)},resize:function(){Q._fullWindow&&Q.setCanvasSize(window.innerWidth,window.innerHeight),Q.render()}},Q.setCanvasSize=function(e,t){Q.width=e,Q.height=t,Q.camera.aspect=e/t,Q.camera.updateProjectionMatrix(),Q.renderer.setSize(e,t)},Q.buildCamera=function(e){Q.camera=e?new THREE.OrthographicCamera(-Q.width/10,Q.width/10,Q.height/10,-Q.height/10,.1,1e3):new THREE.PerspectiveCamera(45,Q.width/Q.height,.1,1e3),Q.camera.position.set(0,100,100)},Q.currentViewUrl=function(){var e=Q.camera.position,t=Q.controls.target,r=Q.camera.up,a="#cx="+e.x+"&cy="+e.y+"&cz="+e.z;return(t.x||t.y||t.z)&&(a+="&tx="+t.x+"&ty="+t.y+"&tz="+t.z),(r.x||r.y||1!=r.z)&&(a+="&ux="+r.x+"&uy="+r.y+"&uz="+r.z),window.location.href.split("#")[0]+a},Q.start=function(){Q.controls&&(Q.controls.enabled=!0)},Q.pause=function(){Q.running=!1,Q.controls&&(Q.controls.enabled=!1)},Q.resume=function(){Q.controls&&(Q.controls.enabled=!0)},Q.startAnimation=function(){Q.running=!0,Q.animate()},Q.stopAnimation=function(){Q.running=!1},Q.animate=function(){Q.running&&requestAnimationFrame(Q.animate),Q.render(!0)},Q.render=function(e){e&&Q.controls.update(),Q.renderer.render(Q.scene,Q.camera),Q.updateLabelPosition()},Q.updateLabelPosition=function(){var e=Q.scene.labelConnectorGroup;if(Q.labelVisibility&&0!=e.children.length){for(var t,r,a,o=Q.camera,i=o.position,n=Q.controls.target.clone().sub(i),s=new THREE.Vector3,l=new THREE.Vector3,c=[],d=0,p=e.children.length;d<p;d++)if((t=e.children[d]).visible)for(var h=0,u=t.children.length;h<u;h++)a=(r=t.children[h]).geometry.vertices[0],l.set(a.x,a.z,-a.y),0<s.subVectors(l,i).dot(n)?c.push([r,a,i.distanceTo(l)]):r.userData.elem.style.display="none";if(0!=c.length){c.sort(function(e,t){return e[2]<t[2]?1:e[2]>t[2]?-1:0});var y,f,m,b,E,v,D=Q.width/2,g=Q.height/2,w=Q3D.Options.label.autoSize,M=Q3D.Options.label.minFontSize;for(d=0,p=c.length;d<p;d++)y=c[d][0],a=c[d][1],f=c[d][2],l.set(a.x,a.z,-a.y).project(o),m=l.x*D+D,b=-l.y*g+g,(E=y.userData.elem).style.display="block",E.style.left=m-E.offsetWidth/2+"px",E.style.top=b-E.offsetHeight/2+"px",E.style.zIndex=d+1,w&&(f<10&&(f=10),v=Math.max(Math.round(1e3/f),M),E.style.fontSize=v+"px")}}},Q.setLabelVisibility=function(e){Q.labelVisibility=e,Q.scene.labelRootElement.style.display=e?"block":"none",Q.scene.labelConnectorGroup.visible=e,Q.render()},Q.setRotateAnimationMode=function(e){e?(Q.controls.autoRotate=!0,Q.startAnimation()):(Q.controls.autoRotate=!1,Q.stopAnimation())},Q.setWireframeMode=function(e){if(e!=Q._wireframeMode){for(var t in Q.scene.mapLayers)Q.scene.mapLayers[t].setWireframeMode(e);Q._wireframeMode=e,Q.render()}},Q.intersectObjects=function(e,t){var r=new THREE.Vector2(e/Q.width*2-1,-t/Q.height*2+1),a=new THREE.Raycaster;return a.linePrecision=.2,a.setFromCamera(r,Q.camera),a.intersectObjects(Q.scene.queryableObjects())},Q._offset=function(e){for(var t=0,r=0;t+=e.offsetTop||0,r+=e.offsetLeft||0,e=e.offsetParent;);return{top:t,left:r}},Q.help=function(){var e=void 0===Q3D.Controls?[]:Q3D.Controls.keyList;-1==e.indexOf("* Keys")&&e.push("* Keys"),e=e.concat(["I : Información de Pagina","R : Iniciar/Terminar Rotacion","W : Modo Wireframe","Shift + R : Reiniciar Vista","Shift + S : Guardar Imagen"]);var r="<table>";return e.forEach(function(e){if(""!=e.trim())if("*"==e[0])r+='<tr><td colspan="2" class="star">'+e.substr(1).trim()+"</td></tr>";else if(-1==e.indexOf(":"))r+='<tr><td colspan="2">'+e.trim()+"</td></tr>";else{var t=e.split(":");r+="<tr><td>"+t[0].trim()+"</td><td>"+t[1].trim()+"</td></tr>"}}),r+="</table>"},Q.popup={modal:!1,show:function(e,t,r){r?Q.pause():this.modal&&Q.resume(),this.modal=Boolean(r);var a=Q3D.$("informac");void 0===e?(a.style.display="none",Q3D.$("pageinfo").style.display="block"):(Q3D.$("pageinfo").style.display="none",e instanceof HTMLElement?(a.innerHTML="",a.appendChild(e)):a.innerHTML=e,a.style.display="block"),Q3D.$("popupbar").innerHTML=t||"",Q3D.$("popup").style.display="block"},hide:function(){Q3D.$("popup").style.display="none",this.modal&&Q.resume()}},Q.showInfo=function(){Q3D.$("urlbox").value=Q.currentViewUrl(),Q3D.$("usage").innerHTML=Q.help(),Q.popup.show()},Q.showQueryResult=function(e,t){var r=Q.scene.mapLayers[t.userData.layerId],a=[];r&&(a.push('<table class="layer">'),a.push("<caption>Capa</caption>"),a.push("<tr><td>"+r.properties.name+"</td></tr>"),a.push("</table>")),a.push("</td></tr></table>"),void 0!==r.properties.propertyNames&&(a.push('<table class="attrs">'),a.push("<caption></caption>"),a.push("<tr><td style='width:90%;'>Metros Cuadrados Construidos</td><td>"+t.userData.properties[5]+"</td></tr>"),a.push("</table>")),Q.popup.show(a.join(""))},Q.showPrintDialog=function(){function e(e,t,r){var a=document.createElement(e);return t&&t.appendChild(a),r&&(a.innerHTML=r),a}var t=e("form");t.className="print",e("div",t,"Image Size").style.textDecoration="underline";var r=e("div",t),a=e("label",r,"Width:"),o=e("input",r);r.style.cssFloat="left",a.htmlFor=o.id=o.name="printwidth",o.type="text",o.value=Q.width,e("span",r,"px,");var i=e("div",t),n=e("label",i,"Height:"),s=e("input",i);n.htmlFor=s.id=s.name="printheight",s.type="text",s.value=Q.height,e("span",i,"px");var l=e("div",t),c=e("input",l);c.type="checkbox",c.checked=!0,e("span",l,"Keep Aspect Ratio"),e("div",t,"Option").style.textDecoration="underline";var d=e("div",t),p=e("input",d);p.type="checkbox",p.checked=!0,e("span",d,"Fill Background");var h=e("div",t),u=e("span",h,"OK"),y=e("span",h,"Cancel");h.className="buttonbox",e("input",t).type="submit";var f=Q.width/Q.height;o.oninput=function(){c.checked&&(s.value=Math.round(o.value/f))},s.oninput=function(){c.checked&&(o.value=Math.round(s.value*f))},u.onclick=function(){Q.popup.show("Rendering..."),window.setTimeout(function(){Q.saveCanvasImage(o.value,s.value,p.checked)},10)},y.onclick=Q.closePopup,t.onsubmit=function(){return u.onclick(),!1},Q.popup.show(t,"Save Image",!0)},Q.closePopup=function(){Q.popup.hide(),Q.queryMarker.visible=!1,Q.highlightFeature(null),Q._canvasImageUrl&&(URL.revokeObjectURL(Q._canvasImageUrl),Q._canvasImageUrl=null)},Q.highlightFeature=function(e){if(Q.highlightObject&&(Q.scene.remove(Q.highlightObject),Q.selectedObject=null,Q.highlightObject=null),null!==e){var t=Q.scene.mapLayers[e.userData.layerId];if(void 0!==t&&t.type!=Q3D.LayerType.DEM&&-1==["Icon","JSON model","COLLADA model"].indexOf(t.objType)){var r=t.type==Q3D.LayerType.Point?1.01:1,a=e.clone();a.traverse(function(e){e.material=Q.highlightMaterial}),1!=r&&a.scale.set(a.scale.x*r,a.scale.y*r,a.scale.z*r),Q.scene.add(a),Q.selectedObject=e,Q.highlightObject=a}}},Q.canvasClicked=function(e){for(var t,r,a=Q._offset(Q.renderer.domElement),o=Q.intersectObjects(e.clientX-a.left,e.clientY-a.top),i=0,n=o.length;i<n;i++){r={x:(t=o[i]).point.x,y:-t.point.z,z:t.point.y},Q.queryMarker.position.set(r.x,r.y,r.z),Q.queryMarker.visible=!0,Q.queryMarker.updateMatrixWorld();for(var s=t.object;s&&void 0===s.userData.layerId;)s=s.parent;return Q.highlightFeature(s),Q.showQueryResult(r,s),void Q.render()}Q.closePopup()},Q.saveCanvasImage=function(E,v,e,t){var r;void 0===e&&(e=!0),E&&v&&(r=[Q.width,Q.height],Q.setCanvasSize(E,v));var i=function(e){var t="image.png";if(void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(e,t),Q.popup.hide();else{Q._canvasImageUrl&&URL.revokeObjectURL(Q._canvasImageUrl),Q._canvasImageUrl=URL.createObjectURL(e);var r=document.createElement("a");r.className="download-link",r.href=Q._canvasImageUrl,r.download=t,r.innerHTML="Save",Q.popup.show("Click to save the image to a file."+r.outerHTML,"Image is ready")}},a=t||function(e){if(void 0!==e.toBlob)e.toBlob(i);else{for(var t=atob(e.toDataURL("image/png").split(",")[1]),r=t.length,a=new Uint8Array(r),o=0;o<r;o++)a[o]=t.charCodeAt(o);i(new Blob([a],{type:"image/png"}))}},D=[];if(Q.labelVisibility)for(var o,n,s,l=Q.scene.labelConnectorGroup,c=0;c<l.children.length;c++)if((o=l.children[c]).visible)for(var d=0;d<o.children.length;d++)s=(n=o.children[d]).geometry.vertices[0],D.push({pt:new THREE.Vector3(s.x,s.z,-s.y),text:n.userData.elem.textContent});var p=function(){r&&Q.setCanvasSize(r[0],r[1]),Q.render()};e||Q.renderer.setClearColor(0,0),Q.renderer.preserveDrawingBuffer=!0,Q.renderer.render(Q.scene,Q.camera);var h=Q3D.Options.bgcolor;if(Q.renderer.setClearColor(h||0,null===h?0:1),e&&null===h||0<D.length){var u=document.createElement("canvas");u.width=E,u.height=v;var y=u.getContext("2d");if(e&&null===h){var f=y.createLinearGradient(0,0,0,v);f.addColorStop(0,"#98c8f6"),f.addColorStop(.4,"#cbebff"),f.addColorStop(1,"#f0f9ff"),y.fillStyle=f,y.fillRect(0,0,E,v)}var m=new Image;m.onload=function(){y.drawImage(m,0,0,E,v),0<D.length&&function(e){e.textAlign="center",e.textBaseline="middle";var t=document.createElement("div");t.className="print-label",document.body.appendChild(t);var r=document.defaultView.getComputedStyle(t,""),a=r.color;e.font=r.font,document.body.removeChild(t);for(var o,i,n,s=E/2,l=v/2,c=Q.camera,d=c.position,p=Q.controls.target.clone().sub(d),h=new THREE.Vector3,u=new THREE.Vector3,y=[],f=0,m=D.length;f<m;f++)y.push([f,d.distanceTo(D[f].pt)]);y.sort(function(e,t){return e[1]<t[1]?1:e[1]>t[1]?-1:0});for(f=0,m=y.length;f<m;f++)if(o=D[y[f][0]],0<h.subVectors(o.pt,d).dot(p)){if(u.copy(o.pt).project(c),i=u.x*s+s,n=-u.y*l+l,i<0||E<=i||n<0||v<=n)continue;e.fillStyle="#FFF";for(var b=0;b<9;b++)4!=b&&e.fillText(o.text,i+Math.floor(b/3)-1,n+b%3-1);e.fillStyle=a,e.fillText(o.text,i,n)}}(y),a(u),p()},m.src=Q.renderer.domElement.toDataURL("image/png")}else a(Q.renderer.domElement),p()}}(),Q3D.Material=function(){},Q3D.Material.prototype={constructor:Q3D.Material,loadJSONObject:function(e,t){var r=this.origProp=e,a={};if(r.ds&&!Q3D.isIE&&(a.side=THREE.DoubleSide),r.flat&&(a.shading=THREE.FlatShading),void 0!==r.image){var o=r.image;if(void 0!==o.url)a.map=Q3D.application.loadTextureFile(o.url,t);else if(void 0!==o.object)a.map=new THREE.Texture(o.object.toImageData()),a.map.needsUpdate=!0,t();else{var i=new Image;i.onload=function(){a.map.needsUpdate=!0,t()},i.src=o.base64,a.map=new THREE.Texture(i)}}void 0!==r.o&&r.o<1&&(a.opacity=r.o,a.transparent=!0),r.t&&(a.transparent=!0),r.w&&(a.wireframe=!0),r.type==Q3D.MaterialType.MeshLambert?(void 0!==r.c&&(a.color=r.c),this.mtl=new THREE.MeshLambertMaterial(a)):r.type==Q3D.MaterialType.MeshPhong?(void 0!==r.c&&(a.color=r.c),this.mtl=new THREE.MeshPhongMaterial(a)):r.type==Q3D.MaterialType.LineBasic?(a.color=r.c,this.mtl=new THREE.LineBasicMaterial(a)):(a.color=16777215,this.mtl=new THREE.SpriteMaterial(a))},set:function(e){this.mtl=e,this.origProp={}},type:function(){return this.mtl instanceof THREE.MeshLambertMaterial?Q3D.MaterialType.MeshLambert:this.mtl instanceof THREE.MeshPhongMaterial?Q3D.MaterialType.MeshPhong:this.mtl instanceof THREE.LineBasicMaterial?Q3D.MaterialType.LineBasic:this.mtl instanceof THREE.SpriteMaterial?Q3D.MaterialType.Sprite:void 0!==this.mtl?null===this.mtl?null:Q3D.MaterialType.Unknown:void 0},dispose:function(){this.mtl&&(this.mtl.map&&this.mtl.map.dispose(),this.mtl.dispose(),this.mtl=null)}},Q3D.Materials=function(){this.materials=[]},Q3D.Materials.prototype=Object.create(THREE.EventDispatcher.prototype),Q3D.Materials.prototype.constructor=Q3D.Materials,Q3D.Materials.prototype.add=function(e){if(e instanceof Q3D.Material)this.materials.push(e);else{var t=new Q3D.Material;t.set(e),this.materials.push(t)}},Q3D.Materials.prototype.get=function(e){return this.materials[e]},Q3D.Materials.prototype.mtl=function(e){return this.materials[e].mtl},Q3D.Materials.prototype.loadJSONObject=function(e){for(var t=this,r=!1,a=function(){r&&t.dispatchEvent({type:"renderRequest"})},o=0,i=e.length;o<i;o++){var n=new Q3D.Material;n.loadJSONObject(e[o],a),this.add(n)}r=!0},Q3D.Materials.prototype.dispose=function(){for(var e=0,t=this.materials.length;e<t;e++)this.materials[e].dispose();this.materials=[]},Q3D.Materials.prototype.setOpacity=function(e){for(var t,r=0,a=this.materials.length;r<a;r++)(t=this.materials[r]).mtl.transparent=Boolean(t.origProp.t)||e<1,t.mtl.opacity=e},Q3D.Materials.prototype.setWireframeMode=function(e){for(var t,r=0,a=this.materials.length;r<a;r++)(t=this.materials[r]).origProp.w||t.mtl instanceof THREE.LineBasicMaterial||(t.mtl.wireframe=e)},Q3D.DEMBlock=function(){},Q3D.DEMBlock.prototype={constructor:Q3D.DEMBlock,loadJSONObject:function(i,n,s){var l=this,c=i.grid;this.data=i,this.material=new Q3D.Material,this.material.loadJSONObject(i.material,function(){s&&s(l)}),n.materials.add(this.material);var d=new THREE.PlaneBufferGeometry(i.width,i.height,c.width-1,c.height-1),p=new THREE.Mesh(d,this.material.mtl);void 0!==i.translate&&p.position.set(i.translate[0],i.translate[1],i.translate[2]);var t=function(e){for(var t=d.attributes.position.array,r=0,a=0,o=t.length;r<o;r++,a+=3)t[a+2]=e[r];d.attributes.position.needsUpdate=!0,n.properties.shading&&(d.computeFaceNormals(),d.computeVertexNormals()),i.sides&&(l.buildSides(n,c,i.width,i.height,p,Q3D.Options.side.bottomZ),n.sideVisible=!0),i.frame&&(l.buildFrame(n,c,i.width,i.height,p,Q3D.Options.frame.bottomZ),n.sideVisible=!0),s&&s(l)};return void 0!==c.url?Q3D.application.loadFile(c.url,"arraybuffer",function(e){c.array=new Float32Array(e),t(c.array)}):(void 0!==c.binary&&(c.array=new Float32Array(c.binary.buffer,0,c.width*c.height)),t(c.array)),this.obj=p},buildSides:function(e,t,r,a,o,i){var n=this.material.origProp,s=void 0!==n.o?n.o:1,l=new THREE.MeshLambertMaterial({color:Q3D.Options.side.color,opacity:s,transparent:s<1});e.materials.add(l);var c,d,p=2*-i,h=t.array,u=t.width,y=t.height,f=Math.PI/2,m=new THREE.PlaneBufferGeometry(r,p,u-1,1),b=new THREE.PlaneBufferGeometry(r,p,u-1,1),E=u*(y-1),v=m.attributes.position.array,D=b.attributes.position.array;for(c=0;c<u;c++)v[3*c+1]=h[E+c],D[3*c+1]=h[u-1-c];(d=new THREE.Mesh(m,l)).rotation.x=f,d.position.y=-a/2,d.name="side",o.add(d),(d=new THREE.Mesh(b,l)).rotation.x=f,d.rotation.y=Math.PI,d.position.y=a/2,d.name="side",o.add(d);var g=new THREE.PlaneBufferGeometry(p,a,1,y-1),w=new THREE.PlaneBufferGeometry(p,a,1,y-1),M=g.attributes.position.array,Q=w.attributes.position.array;for(c=0;c<y;c++)M[3*(2*c+1)]=h[u*c],Q[2*c*3]=-h[u*(c+1)-1];if((d=new THREE.Mesh(g,l)).rotation.y=-f,d.position.x=-r/2,d.name="side",o.add(d),(d=new THREE.Mesh(w,l)).rotation.y=f,d.position.x=r/2,d.name="side",o.add(d),Q3D.Options.exportMode)var L=new THREE.PlaneBufferGeometry(r,a,u-1,y-1);else L=new THREE.PlaneBufferGeometry(r,a,1,1);(d=new THREE.Mesh(L,l)).rotation.x=Math.PI,d.position.z=i,d.name="bottom",o.add(d),o.updateMatrixWorld()},buildFrame:function(e,t,r,a,o,i){var n=this.material.origProp,s=void 0!==n.o?n.o:1,l=new THREE.LineBasicMaterial({color:Q3D.Options.frame.color,opacity:s,transparent:s<1});e.materials.add(l);var c=r/2,d=a/2,p=new THREE.Geometry;p.vertices.push(new THREE.Vector3(-c,-d,i),new THREE.Vector3(c,-d,i),new THREE.Vector3(c,d,i),new THREE.Vector3(-c,d,i),new THREE.Vector3(-c,-d,i));var h=new THREE.Line(p,l);h.name="frame",o.add(h),[[-c,-d,t.array[t.array.length-t.width]],[c,-d,t.array[t.array.length-1]],[c,d,t.array[t.width-1]],[-c,d,t.array[0]]].forEach(function(e){var t=new THREE.Geometry;t.vertices.push(new THREE.Vector3(e[0],e[1],e[2]),new THREE.Vector3(e[0],e[1],i));var r=new THREE.Line(t,l);r.name="frame",o.add(r)}),o.updateMatrixWorld()},getValue:function(e,t){var r=this.data.grid;return 0<=e&&e<r.width&&0<=t&&t<r.height?r.array[e+r.width*t]:null},contains:function(e,t){var r=this.data.translate,a=r[0]-this.data.width/2,o=r[0]+this.data.width/2,i=r[1]-this.data.height/2,n=r[1]+this.data.height/2;return a<=e&&e<=o&&i<=t&&t<=n}},Q3D.ClippedDEMBlock=function(){},Q3D.ClippedDEMBlock.prototype={constructor:Q3D.ClippedDEMBlock,loadJSONObject:function(t,r,a){var o=this,i=t.grid;this.data=t,this.material=new Q3D.Material,this.material.loadJSONObject(t.material,function(){a&&a(o)}),r.materials.add(this.material);var n=new THREE.Mesh(new THREE.Geometry,this.material.mtl);void 0!==t.translate&&n.position.set(t.translate[0],t.translate[1],t.translate[2]);var s=function(e){n.geometry=Q3D.Utils.createOverlayGeometry(t.clip.triangles,t.clip.split_polygons,r.getZ.bind(r)),Q3D.Utils.setGeometryUVs(n.geometry,r.sceneData.width,r.sceneData.height),t.sides&&(o.buildSides(r,n,Q3D.Options.side.bottomZ),r.sideVisible=!0),a&&a(o)};return void 0!==i.url?Q3D.application.loadFile(i.url,"arraybuffer",function(e){i.array=new Float32Array(e),s(i.array)}):(void 0!==i.binary&&(i.array=new Float32Array(i.binary.buffer,0,i.width*i.height)),s(i.array)),this.obj=n},buildSides:function(e,t,r){var a=this.material.origProp,o=void 0!==a.o?a.o:1,i=new THREE.MeshLambertMaterial({color:Q3D.Options.side.color,opacity:o,transparent:o<1});e.materials.add(i);var n,s,l,c,d=this.data.clip.polygons,p=e.getZ.bind(e),h=function(e,t){return r},u=i.clone();u.side=THREE.BackSide,e.materials.add(u);for(var y=0,f=d.length;y<f;y++){for(var m=d[y],b=0,E=m.length;b<E;b++)c=e.segmentizeLineString(m[b],p),n=Q3D.Utils.createWallGeometry(c,h),(s=new THREE.Mesh(n,i)).name="side",t.add(s);l=new THREE.Shape(Q3D.Utils.arrayToVec2Array(m[0]));for(b=1,E=m.length;b<E;b++)l.holes.push(new THREE.Path(Q3D.Utils.arrayToVec2Array(m[b])));n=new THREE.ShapeBufferGeometry(l),(s=new THREE.Mesh(n,u)).position.z=r,s.name="bottom",t.add(s)}t.updateMatrixWorld()},getValue:function(e,t){var r=this.data.grid;return 0<=e&&e<r.width&&0<=t&&t<r.height?r.array[e+r.width*t]:null},contains:function(e,t){var r=this.data.translate,a=r[0]-this.data.width/2,o=r[0]+this.data.width/2,i=r[1]-this.data.height/2,n=r[1]+this.data.height/2;return a<=e&&e<=o&&i<=t&&t<=n}},Q3D.MapLayer=function(){this.opacity=1,this.visible=!0,this.queryable=!0,this.materials=new Q3D.Materials,this.materials.addEventListener("renderRequest",this.requestRender.bind(this)),this.objectGroup=new Q3D.Group,this.queryObjs=[]},Q3D.MapLayer.prototype=Object.create(THREE.EventDispatcher.prototype),Q3D.MapLayer.prototype.constructor=Q3D.MapLayer,Q3D.MapLayer.prototype.addObject=function(e,t){if(void 0===t&&(t=this.queryable),e.userData.layerId=this.id,this.objectGroup.add(e),t){var r=this.queryObjs;e.traverse(function(e){r.push(e)})}},Q3D.MapLayer.prototype.queryableObjects=function(){return this.visible?this.queryObjs:[]},Q3D.MapLayer.prototype.removeAllObjects=function(){this.objectGroup.traverse(function(e){e.geometry&&e.geometry.dispose()}),this.materials.dispose();for(var e=this.objectGroup.children.length-1;0<=e;e--)this.objectGroup.remove(this.objectGroup.children[e]);this.queryObjs=[]},Q3D.MapLayer.prototype.loadJSONObject=function(e,t){void 0!==e.properties&&(this.properties=e.properties,this.setVisible(!1!==e.properties.visible)),void 0!==e.data&&(this.removeAllObjects(),void 0!==e.data.materials&&this.materials.loadJSONObject(e.data.materials)),this.sceneData=t.userData},Q3D.MapLayer.prototype.setOpacity=function(e){this.materials.setOpacity(e),this.opacity=e,this.requestRender()},Q3D.MapLayer.prototype.setVisible=function(e){this.visible=e,this.objectGroup.visible=e,this.requestRender()},Q3D.MapLayer.prototype.setWireframeMode=function(e){this.materials.setWireframeMode(e)},Q3D.MapLayer.prototype.requestRender=function(){this.dispatchEvent({type:"renderRequest"})},Q3D.DEMLayer=function(){Q3D.MapLayer.call(this),this.type=Q3D.LayerType.DEM,this.blocks=[]},Q3D.DEMLayer.prototype=Object.create(Q3D.MapLayer.prototype),Q3D.DEMLayer.prototype.constructor=Q3D.DEMLayer,Q3D.DEMLayer.prototype.loadJSONObject=function(e,t){if("layer"==e.type)Q3D.MapLayer.prototype.loadJSONObject.call(this,e,t),void 0!==e.data&&this.build(e.data);else if("block"==e.type){var r=e.block;this.blocks[r]=void 0===e.clip?new Q3D.DEMBlock:new Q3D.ClippedDEMBlock;var a=this.blocks[r].loadJSONObject(e,this,this.requestRender.bind(this));this.addObject(a)}},Q3D.DEMLayer.prototype.build=function(e){e.forEach(function(e){var t=void 0===e.clip?new Q3D.DEMBlock:new Q3D.ClippedDEMBlock,r=t.loadJSONObject(e,this,this.requestRender.bind(this));this.addObject(r),this.blocks.push(t)},this)},Q3D.DEMLayer.prototype.getZ=function(e,t){for(var r=0,a=this.blocks.length;r<a;r++){var o=this.blocks[r],i=o.data;if(o.contains(e,t)){var n=i.width/(i.grid.width-1),s=i.height/(i.grid.height-1),l=i.translate[0]-i.width/2,c=i.translate[1]+i.height/2,d=Math.floor((e-l)/n),p=Math.floor((c-t)/s),h=[o.getValue(d,p),o.getValue(d+1,p),o.getValue(d,p+1),o.getValue(d+1,p+1)],u=(e-(l+n*d))/n,y=(c-s*p-t)/s;return u<=1-y?h[0]+(h[1]-h[0])*u+(h[2]-h[0])*y:h[3]+(h[2]-h[3])*(1-u)+(h[1]-h[3])*(1-y)}}return null},Q3D.DEMLayer.prototype.segmentizeLineString=function(e,t){void 0===t&&(t=function(){return 0});for(var r=this.sceneData.width,a=this.sceneData.height,o=-r/2,i=a/2,n=this.blocks[0].data.grid,s=r/(n.width-1),l=a/(n.height-1),c=function(e,t){return e-t},d=[],p=1,h=e.length;p<h;p++){for(var u=e[p-1],y=e[p],f=u[0],m=y[0],b=u[1],E=y[1],v=u[2],D=y[2],g=(f-o)/s,w=(m-o)/s,M=(i-b)/l,Q=(i-E)/l,L=[0],T=[[g,w],[M,Q],[Math.abs(M+g),Math.abs(Q+w)]],R=0;R<3;R++){var O=T[R][0],H=T[R][1];if(O!=H)for(var j=Math.ceil(Math.min(O,H)),x=Math.floor(Math.max(O,H));j<=x;j++)L.push((j-O)/(H-O))}L.sort(c);for(var S,V,P,B=null,k=(R=0,L.length);R<k;R++)if(B!==L[R]){if(1==L[R])break;S=f+(m-f)*L[R],V=b+(E-b)*L[R],P=void 0===v||void 0===D?t(S,V):v+(D-v)*L[R],d.push(new THREE.Vector3(S,V,P)),B=L[R]}}var G=e[e.length-1];return d.push(new THREE.Vector3(G[0],G[1],void 0===G[2]?t(G[0],G[1]):G[2])),d},Q3D.DEMLayer.prototype.setVisible=function(e){Q3D.MapLayer.prototype.setVisible.call(this,e)},Q3D.DEMLayer.prototype.setSideVisibility=function(t){this.sideVisible=t,this.objectGroup.traverse(function(e){"side"!=e.name&&"bottom"!=e.name&&"frame"!=e.name||(e.visible=t)})},Q3D.VectorLayer=function(){Q3D.MapLayer.call(this)},Q3D.VectorLayer.prototype=Object.create(Q3D.MapLayer.prototype),Q3D.VectorLayer.prototype.constructor=Q3D.VectorLayer,Q3D.VectorLayer.prototype.build=function(e){},Q3D.VectorLayer.prototype.clearLabels=function(){this.labelConnectorGroup&&this.labelConnectorGroup.clear();var e=this.labelParentElement;if(e)for(;e.lastChild;)e.removeChild(e.lastChild)},Q3D.VectorLayer.prototype.buildLabels=function(e,t){if(void 0!==this.properties.label&&void 0!==t)for(var r,a,o,i,n,s,l=this.sceneData.zShift*this.sceneData.zScale,c=this.properties.label,d=c.index,p=c.relative,h=new THREE.LineBasicMaterial({color:Q3D.Options.label.connectorColor}),u=0,y=e.length;u<y;u++)if(null!==(a=(r=e[u]).prop[d])&&""!==a)for(var f=0,m=(o=t(r)).length;f<m;f++){var b=document.createElement("div");b.appendChild(document.createTextNode(a)),b.className="label",this.labelParentElement.appendChild(b),i=o[f],n=new THREE.Vector3(i[0],i[1],i[2]),s=new THREE.Vector3(i[0],i[1],p?i[2]+r.lh:l+r.lh);var E=new THREE.Geometry;E.vertices.push(s,n);var v=new THREE.Line(E,h);v.userData.layerId=this.id,v.userData.elem=b,this.labelConnectorGroup.add(v)}},Q3D.VectorLayer.prototype.loadJSONObject=function(e,t){"layer"==e.type?(Q3D.MapLayer.prototype.loadJSONObject.call(this,e,t),void 0!==e.data&&(this.clearLabels(),void 0!==this.properties.label&&(void 0===this.labelConnectorGroup&&(this.labelConnectorGroup=new Q3D.Group,this.labelConnectorGroup.userData.layerId=this.id,t.labelConnectorGroup.add(this.labelConnectorGroup)),void 0===this.labelParentElement&&(this.labelParentElement=document.createElement("div"),t.labelRootElement.appendChild(this.labelParentElement))),(e.data.blocks||[]).forEach(function(e){void 0!==e.url?Q3D.application.loadJSONFile(e.url):(this.build(e.features),void 0!==this.properties.label&&this.buildLabels(e.features))},this))):"block"==e.type&&(this.build(e.features),void 0!==this.properties.label&&this.buildLabels(e.features))},Q3D.VectorLayer.prototype.setVisible=function(e){this.labelParentElement&&(this.labelParentElement.style.display=e?"block":"none"),this.labelConnectorGroup&&(this.labelConnectorGroup.visible=e),Q3D.MapLayer.prototype.setVisible.call(this,e)},Q3D.PointLayer=function(){Q3D.VectorLayer.call(this),this.type=Q3D.LayerType.Point},Q3D.PointLayer.prototype=Object.create(Q3D.VectorLayer.prototype),Q3D.PointLayer.prototype.constructor=Q3D.PointLayer,Q3D.PointLayer.prototype.loadJSONObject=function(e,t){Q3D.VectorLayer.prototype.loadJSONObject.call(this,e,t)},Q3D.PointLayer.prototype.build=function(e){var t=this.properties.objType;if("Icon"!=t)if("JSON model"!=t&&"COLLADA model"!=t){var r,a,o=Math.PI/180,i=90*o;if("Sphere"==t)r=function(e,t){e.scale.set(t.r,t.r,t.r)},a=new THREE.SphereBufferGeometry(1,32,32);else if("Box"==t)r=function(e,t){e.scale.set(t.w,t.h,t.d),e.rotation.x=i},a=new THREE.BoxBufferGeometry(1,1,1);else if("Disk"==t){var n=Q3D.uv.i,s=Q3D.uv.k,l=void 0===this.ns||0==this.ns?this.sceneData.zExaggeration:1;r=function(e,t){e.scale.set(t.r,1,t.r*l),e.rotateOnWorldAxis(n,(90-t.d)*o),e.rotateOnWorldAxis(s,-t.dd*o)},a=new THREE.CylinderBufferGeometry(1,1,1e-4,32)}else r=function(e,t){e.scale.set(t.r,t.h,t.r),e.rotation.x=i},a="Cylinder"==t?new THREE.CylinderBufferGeometry(1,1,1,32):new THREE.CylinderBufferGeometry(0,1,1,32);for(var c,d,p,h,u,y,f,m=this.materials,b=0,E=e.length;b<E;b++)for(p=(d=(c=e[b]).geom).h?d.h/2:0,h=0,u=d.pts.length;h<u;h++)r(y=new THREE.Mesh(a,m.mtl(c.mtl)),d),f=d.pts[h],y.position.set(f[0],f[1],f[2]+p),y.userData.properties=c.prop,this.addObject(y)}else this.buildModels(e);else this.buildIcons(e)},Q3D.PointLayer.prototype.buildIcons=function(e){for(var t=0,r=e.length;t<r;t++)for(var a=e[t],o=a.geom,i=this.materials.mtl(a.mtl),n=scene.images[i.i],s=void 0===o.scale?1:o.scale,l=n.width/64*s,c=n.height/64*s,d=0,p=o.pts.length;d<p;d++){var h=o.pts[d],u=new THREE.Sprite(i);u.position.set(h[0],h[1],h[2]),u.scale.set(l,c,s),u.mesh.userData.properties=a.prop,this.addObject(u)}},Q3D.PointLayer.prototype.buildModels=function(e){for(var t=0,r=e.length;t<r;t++){var a=e[t];Q3D.application.modelBuilders[a.model_index].addFeature(this.userData.id,t)}},Q3D.PointLayer.prototype.buildLabels=function(e){Q3D.VectorLayer.prototype.buildLabels.call(this,e,function(e){return e.geom.pts})},Q3D.LineLayer=function(){Q3D.VectorLayer.call(this),this.type=Q3D.LayerType.Line},Q3D.LineLayer.prototype=Object.create(Q3D.VectorLayer.prototype),Q3D.LineLayer.prototype.constructor=Q3D.LineLayer,Q3D.LineLayer.prototype.loadJSONObject=function(e,t){Q3D.VectorLayer.prototype.loadJSONObject.call(this,e,t)},Q3D.LineLayer.prototype.build=function(e){var t,r=this.properties.objType,w=this.materials,a=this.sceneData;if(r==this._lastObjType&&void 0!==this._createObject)t=this._createObject;else if("Line"==r)t=function(e,t){for(var r,a=new THREE.Geometry,o=0,i=t.length;o<i;o++)r=t[o],a.vertices.push(new THREE.Vector3(r[0],r[1],r[2]));return new THREE.Line(a,w.mtl(e.mtl))};else if("Pipe"==r||"Cone"==r){var i,n;"Pipe"==r?(i=new THREE.SphereBufferGeometry(1,32,32),n=new THREE.CylinderBufferGeometry(1,1,1,32)):n=new THREE.CylinderBufferGeometry(0,1,1,32);var s,l=new THREE.Vector3,c=new THREE.Vector3,d=new THREE.Vector3,p=Q3D.uv.j;t=function(e,t){var r=new Q3D.Group;l.set(t[0][0],t[0][1],t[0][2]);for(var a=1,o=t.length;a<o;a++)c.set(t[a][0],t[a][1],t[a][2]),(s=new THREE.Mesh(n,w.mtl(e.mtl))).scale.set(e.geom.r,l.distanceTo(c),e.geom.r),s.position.set((l.x+c.x)/2,(l.y+c.y)/2,(l.z+c.z)/2),s.quaternion.setFromUnitVectors(p,d.subVectors(c,l).normalize()),r.add(s),i&&a<o-1&&((s=new THREE.Mesh(i,w.mtl(e.mtl))).scale.set(e.geom.r,e.geom.r,e.geom.r),s.position.copy(c),r.add(s)),l.copy(c);return r}}else if("Box"==r){var o,M=Q3D.Options.debugMode,Q=[];o=[[0,5,4],[4,5,1],[3,0,7],[7,0,4],[6,3,2],[2,3,7],[4,1,0],[0,1,5],[1,2,5],[5,2,6],[2,7,6],[6,7,3]];for(var L=0;L<12;L++)Q.push(new THREE.Face3(o[L][0],o[L][1],o[L][2]));t=function(e,t){var r,a,o,i,n,s,l,c,d=new THREE.Geometry,p=new Q3D.Group,h=new THREE.Vector3,u=new THREE.Vector3,y=new THREE.Vector3,f=new THREE.Vector3,m=new THREE.Vector3,b=new THREE.Vector3(1,1,1),E=new THREE.Matrix4,v=new THREE.Quaternion;h.set(t[0][0],t[0][1],t[0][2]);for(var D=1,g=t.length;D<g;D++){for(u.set(t[D][0],t[D][1],t[D][2]),o=h.distanceTo(u),y.subVectors(u,h),i=Math.atan2(y.z,Math.sqrt(y.x*y.x+y.y*y.y)),n=Math.atan2(y.y,y.x)-Math.PI/2,m.set((h.x+u.x)/2,(h.y+u.y)/2,(h.z+u.z)/2),v.setFromEuler(new THREE.Euler(i,0,n,"ZXY")),E.compose(m,v,b),r=new THREE.BoxGeometry(e.geom.w,o,e.geom.h),M?((a=new THREE.Mesh(r,w.mtl(e.mtl))).position.set(m.x,m.y,m.z),a.rotation.set(i,0,n,"ZXY"),p.add(a)):(r.applyMatrix(E),d.merge(r)),s=[[-e.geom.w/2,e.geom.h/2],[e.geom.w/2,e.geom.h/2],[e.geom.w/2,-e.geom.h/2],[-e.geom.w/2,-e.geom.h/2]],l=[],L=0;L<4;L++)f.set(s[L][0],-o/2,s[L][1]),f.applyMatrix4(E),l.push(f.clone());for(c&&((r=new THREE.Geometry).vertices=c.concat(l),r.faces=Q,M?(r.computeFaceNormals(),p.add(new THREE.Mesh(r))):d.merge(r)),c=[],L=0;L<4;L++)f.set(s[L][0],o/2,s[L][1]),f.applyMatrix4(E),c.push(new THREE.Vector3(f.x,f.y,f.z));h.copy(u)}return M?p:(d.mergeVertices(),d.computeFaceNormals(),new THREE.Mesh(d,w.mtl(e.mtl)))}}else if("Profile"==r){var h=a.zShift*a.zScale;t=function(r,e){for(var t,a=[],o=0,i=e.length;o<i;o++)t=e[o],a.push(new THREE.Vector3(t[0],t[1],t[2]));return new THREE.Mesh(Q3D.Utils.createWallGeometry(a,function(e,t){return h+r.geom.bh}),w.mtl(r.mtl))}}for(var u=0,y=e.length;u<y;u++)for(var f=e[u],m=f.geom,b=0,E=m.lines.length;b<E;b++){var v=t(f,m.lines[b]);v.userData.properties=f.prop,this.addObject(v)}this._lastObjType=r,this._createObject=t},Q3D.LineLayer.prototype.buildLabels=function(e){},Q3D.PolygonLayer=function(){Q3D.VectorLayer.call(this),this.type=Q3D.LayerType.Polygon,this.borderVisible=!0,this.sideVisible=!0},Q3D.PolygonLayer.prototype=Object.create(Q3D.VectorLayer.prototype),Q3D.PolygonLayer.prototype.constructor=Q3D.PolygonLayer,Q3D.PolygonLayer.prototype.loadJSONObject=function(e,t){Q3D.VectorLayer.prototype.loadJSONObject.call(this,e,t)},Q3D.PolygonLayer.prototype.build=function(e){var t,r,a,y=this.materials,o=this.sceneData;if(this.properties.objType==this._lastObjType&&void 0!==this._createObject)t=this._createObject;else if("Extruded"==this.properties.objType){var i=function(e,t,r){var a,o,i,n,s=new THREE.Shape(Q3D.Utils.arrayToVec2Array(t[0]));for(a=1,o=t.length;a<o;a++)s.holes.push(new THREE.Path(Q3D.Utils.arrayToVec2Array(t[a])));var l=new THREE.ExtrudeBufferGeometry(s,{bevelEnabled:!1,amount:e.geom.h}),c=new THREE.Mesh(l,y.mtl(e.mtl.face));if(c.position.z=r,void 0!==e.mtl.border){var d,p,h,u=function(e,t){return 0};for(a=0,o=t.length;a<o;a++)for(h=Q3D.Utils.arrayToVec3Array(t[a],u),(l=new THREE.Geometry).vertices=h,d=new THREE.Line(l,y.mtl(e.mtl.border)),c.add(d),(d=new THREE.Line(l,y.mtl(e.mtl.border))).position.z=e.geom.h,c.add(d),i=0,n=l.vertices.length-1;i<n;i++)p=h[i],(l=new THREE.Geometry).vertices.push(p,new THREE.Vector3(p.x,p.y,p.z+e.geom.h)),d=new THREE.Line(l,y.mtl(e.mtl.border)),c.add(d)}return c};t=function(e){if(1==e.geom.polygons.length)return i(e,e.geom.polygons[0],e.geom.centroids[0][2]);for(var t=new THREE.Group,r=0,a=e.geom.polygons.length;r<a;r++)t.add(i(e,e.geom.polygons[r],e.geom.centroids[r][2]));return t}}else{var n=o.zShift*o.zScale;t=function(r){var e,t;r.geom.polygons?(e=r.geom.polygons,t=function(e,t){return n+r.geom.h}):e=r.geom.split_polygons||[];var a=Q3D.Utils.createOverlayGeometry(r.geom.triangles,e,t);return new THREE.Mesh(a,y.mtl(r.mtl))}}for(var s=0,l=e.length;s<l;s++)(a=t(r=e[s])).userData.properties=r.prop,this.addObject(a);this._lastObjType=this.properties.objType,this._createObject=t},Q3D.PolygonLayer.prototype.buildLabels=function(e){Q3D.VectorLayer.prototype.buildLabels.call(this,e,function(e){return e.geom.centroids})},Q3D.PolygonLayer.prototype.setBorderVisibility=function(o){"Overlay"==this.properties.objType&&(this.objectGroup.children.forEach(function(e){for(var t=0,r=e.children.length;t<r;t++){var a=e.children[t];a instanceof THREE.Line&&(a.visible=o)}}),this.borderVisible=o)},Q3D.PolygonLayer.prototype.setSideVisibility=function(o){"Overlay"==this.properties.objType&&(this.objectGroup.children.forEach(function(e){for(var t=0,r=e.children.length;t<r;t++){var a=e.children[t];a instanceof THREE.Mesh&&(a.visible=o)}}),this.sideVisible=o)},Q3D.ModelBuilder={},Q3D.ModelBuilder._loaders={},Q3D.ModelBuilder.Base=function(e,t){this.scene=e,this.features=[],this._objects={},this.loaded=!1},Q3D.ModelBuilder.Base.prototype={constructor:Q3D.ModelBuilder.Base,addFeature:function(e,t){this.features.push({layerId:e,featureId:t}),this.buildObjects()},buildObjects:function(){if(this.loaded){var s=Math.PI/180,l=new THREE.Matrix4;this.features.forEach(function(e){for(var t=this.scene.mapLayers[e.layerId],r=t.f[e.featureId],a=0,o=r.pts.length;a<o;a++){var i=r.pts[a],n=this.cloneObject(e.layerId);r.rotateX&&n.applyMatrix(l.makeRotationX(r.rotateX*s)),r.rotateY&&n.applyMatrix(l.makeRotationY(r.rotateY*s)),r.rotateZ&&n.applyMatrix(l.makeRotationZ(r.rotateZ*s)),void 0!==r.scale&&n.scale.set(r.scale,r.scale,r.scale),n.position.set(i[0],i[1],i[2]),n.userData.featureId=e.featureId,t.addObject(n)}},this),this.features=[]}},cloneObject:function(e){if(void 0===this.object)return null;if(e in this._objects)return this._objects[e].clone();var t=this.scene.mapLayers[e],r=this.object.clone();return Object.keys(this._objects).length?r.traverse(function(e){e instanceof THREE.Mesh!=!1&&(e.material=e.material.clone(),t.materials.add(e.material))}):r.traverse(function(e){e instanceof THREE.Mesh!=!1&&t.materials.add(e.material)}),(this._objects[e]=r).clone()},onLoad:function(e){this.object=e,this.loaded=!0,this.buildObjects()}},Q3D.ModelBuilder.JSON=function(e,t){Q3D.ModelBuilder.Base.call(this,e,t);var r=Q3D.ModelBuilder._loaders;if(void 0===r.jsonLoader&&(r.jsonLoader=new THREE.JSONLoader(!0)),this.loader=r.jsonLoader,void 0!==t.src)this.loader.load(t.src,this.onLoad.bind(this));else if(t.data){var a=this.loader.parse(JSON.parse(t.data));this.onLoad(a.geometry,a.materials)}},Q3D.ModelBuilder.JSON.prototype=Object.create(Q3D.ModelBuilder.Base.prototype),Q3D.ModelBuilder.JSON.prototype.constructor=Q3D.ModelBuilder.JSON,Q3D.ModelBuilder.JSON.prototype.onLoad=function(e,t){this.geometry=e,this.material=new THREE.MeshFaceMaterial(t),Q3D.ModelBuilder.Base.prototype.onLoad.call(this,new THREE.Mesh(this.geometry,this.material))},Q3D.ModelBuilder.JSONObject=function(e,t){Q3D.ModelBuilder.Base.call(this,e,t);var r=Q3D.ModelBuilder._loaders;void 0===r.jsonObjectLoader&&(r.jsonObjectLoader=new THREE.ObjectLoader),this.loader=r.jsonObjectLoader,void 0!==t.src?this.loader.load(t.src,this.onLoad.bind(this)):t.data&&this.onLoad(this.loader.parse(JSON.parse(t.data)))},Q3D.ModelBuilder.JSONObject.prototype=Object.create(Q3D.ModelBuilder.Base.prototype),Q3D.ModelBuilder.JSONObject.prototype.constructor=Q3D.ModelBuilder.JSONObject,Q3D.ModelBuilder.COLLADA=function(e,t){Q3D.ModelBuilder.Base.call(this,e,t);var r=Q3D.ModelBuilder._loaders;if(void 0===r.colladaLoader&&(r.colladaLoader=new THREE.ColladaLoader),this.loader=r.colladaLoader,void 0!==t.src)this.loader.load(t.src,this.onLoad.bind(this));else if(t.data){var a=(new DOMParser).parseFromString(t.data,"application/xml");this.onLoad(this.loader.parse(a,void 0,"./"))}},Q3D.ModelBuilder.COLLADA.prototype=Object.create(Q3D.ModelBuilder.Base.prototype),Q3D.ModelBuilder.COLLADA.prototype.constructor=Q3D.ModelBuilder.COLLADA,Q3D.ModelBuilder.COLLADA.prototype.onLoad=function(e){this.collada=e,Q3D.ModelBuilder.Base.prototype.onLoad.call(this,e.scene)},Q3D.Utils={},Q3D.Utils.putStick=function(e,t,r,a){void 0===Q3D.Utils._stick_mat&&(Q3D.Utils._stick_mat=new THREE.LineBasicMaterial({color:16711680})),void 0===a&&(a=.2),void 0===r&&(r=function(e,t){return Q3D.application.scene.mapLayers[0].getZ(e,t)});var o=r(e,t),i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(e,t,o+a),new THREE.Vector3(e,t,o));var n=new THREE.Line(i,Q3D.Utils._stick_mat);Q3D.application.scene.add(n)},Q3D.Utils.convertToDMS=function(e,t){function r(e){var t=Math.floor(e),r=60*(e-t),a=Math.floor(r),o=60*(r-a);return t+"°"+("0"+a).slice(-2)+"′"+(o<10?"0":"")+o.toFixed(2)+"″"}return(e<0?"S":"N")+r(Math.abs(e))+", "+(t<0?"W":"E")+r(Math.abs(t))},Q3D.Utils.createWallGeometry=function(e,t){for(var r,a=new THREE.PlaneBufferGeometry(0,0,e.length-1,1),o=a.attributes.position.array,i=0,n=0,s=e.length,l=3*s;i<s;i++,n+=3)r=e[i],o[n]=o[n+l]=r.x,o[n+1]=o[n+l+1]=r.y,o[n+2]=t(r.x,r.y),o[n+l+2]=r.z;return a.computeFaceNormals(),a.computeVertexNormals(),a},Q3D.Utils.arrayToVec2Array=function(e){for(var t,r=[],a=0,o=e.length;a<o;a++)t=e[a],r.push(new THREE.Vector2(t[0],t[1]));return r},Q3D.Utils.arrayToVec3Array=function(e,t){var r,a=[];if(void 0===t)for(var o=0,i=e.length;o<i;o++)r=e[o],a.push(new THREE.Vector3(r[0],r[1],r[2]));else for(o=0,i=e.length;o<i;o++)r=e[o],a.push(new THREE.Vector3(r[0],r[1],t(r[0],r[1])));return a},Q3D.Utils.arrayToFace3Array=function(e){for(var t,r=[],a=0,o=e.length;a<o;a++)t=e[a],r.push(new THREE.Face3(t[0],t[1],t[2]));return r},Q3D.Utils.createOverlayGeometry=function(e,t,r){var a=new THREE.Geometry;void 0!==e&&(a.vertices=Q3D.Utils.arrayToVec3Array(e.v,r),a.faces=Q3D.Utils.arrayToFace3Array(e.f));for(var o=0,i=t.length;o<i;o++){var n=t[o],s=new THREE.Geometry,l=[];s.vertices=Q3D.Utils.arrayToVec3Array(n[0],r);for(var c=1,d=n.length;c<d;c++)l.push(Q3D.Utils.arrayToVec3Array(n[c],r));var p=THREE.ShapeUtils.triangulateShape(s.vertices,l);for(c=0,d=l.length;c<d;c++)Array.prototype.push.apply(s.vertices,l[c]);s.faces=Q3D.Utils.arrayToFace3Array(p),a.merge(s)}return a.mergeVertices(),a.computeFaceNormals(),a.computeVertexNormals(),a},Q3D.Utils.setGeometryUVs=function(e,t,r){for(var a,o,i=[],n=0,s=e.vertices.length;n<s;n++)o=e.vertices[n],i.push(new THREE.Vector2(o.x/t+.5,o.y/r+.5));e.faceVertexUvs[0]=[];for(n=0,s=e.faces.length;n<s;n++)a=e.faces[n],e.faceVertexUvs[0].push([i[a.a],i[a.b],i[a.c]])};